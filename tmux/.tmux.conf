# Set the default shell to ZSH
set-option -g default-shell $SHELL

#  plugins
set -g @plugin 'tmux-plugins/tpm'
set -g @plugin 'tmux-plugins/tmux-sensible'
set -g @plugin 'yardnsm/tmux-1password'
set -g @plugin 'christoomey/vim-tmux-navigator'
set -g @plugin 'tmux-plugins/tmux-yank'

# available plugins: battery, cpu-usage, git, gpu-usage, ram-usage, network, network-bandwidth, weather, time
set -g @plugin 'dracula/tmux'
set -g @dracula-plugins "time battery cpu-usage"
set -g @dracula-show-left-icon session

set -g default-terminal 'screen-256color'
set -ag terminal-overrides ",alacritty:RGB"

# Undercurl https://github.com/folke/tokyonight.nvim#making-undercurls-work-properly-in-tmux
set -as terminal-overrides ',*:Smulx=\E[4::%p1%dm'  # undercurl support
set -as terminal-overrides ',*:Setulc=\E[58::2::%p1%{65536}%/%d::%p1%{256}%/%{255}%&%d::%p1%{255}%&%d%;m'  # underscore colours - needs tmux-3.0

# enable mouse manipulations
set -g mouse on

# start window numbers at 1 to match keyboard order with tmux window order
set -g base-index 1
set -g pane-base-index 1
setw -g base-index 1
setw -g pane-base-index 1

# Make sure tmux reports focus changes for vitality.vim
set -g focus-events on

# renumber windows sequentially after closing any of them
set -g renumber-windows on

# Automatically set window title
set-window-option -g automatic-rename on
set-option -g automatic-rename-format '#{b:pane_current_path}'

# increase scrollback lines
set -g history-limit 99999

# By default, all windows in a session are constrained to the size of the
# smallest client connected to that session,
# even if both clients are looking at different windows.
# It seems that in this particular case, Screen has the better default
# where a window is only constrained in size if a smaller client
# is actively looking at it.
setw -g aggressive-resize on

# enable activity alerts
setw -g monitor-activity off
set -g visual-activity off

# Split window shortcut
bind \\ split-window -h -c "#{pane_current_path}"
bind "'" split-window -v -c "#{pane_current_path}"
unbind '"'
unbind %

# <prefix> C-l to clear the screen.
bind C-l send-keys 'C-l'

# Break pane into a new window
bind-key b break-pane -d

# Switch windows with shift arrows
bind End select-window -n
bind Home select-window -p

# easy resize panes
bind -r j resize-pane -D 5
bind -r k resize-pane -U 5
bind -r l resize-pane -R 5
bind -r h resize-pane -L 5

# force Vi mode
set -g status-keys vi
set -g mode-keys vi

# reload configuration
bind R source-file ~/.tmux.conf \; display '~/.tmux.conf sourced'

# address vim mode switching delay (http://superuser.com/a/252717/65504)
set -sg escape-time 0

# fix issues with Shift+PgUp/PgDn scrolling
set -g terminal-overrides 'xterm*:smcup@:rmcup@:RGB'

# go to session
bind-key -r f run-shell "tmux new-window ~/.local/scripts/tmux-sessionizer.sh"

# Setup 'v' to begin selection as in Vim
# http://robots.thoughtbot.com/post/55885045171/tmux-copy-paste-on-os-x-a-better-future
bind-key -T copy-mode-vi v send -X begin-selection
bind-key -T copy-mode-vi y send -X copy-pipe-and-cancel "reattach-to-user-namespace pbcopy"

# Update default binding of `Enter` to also use copy-pipe
unbind-key -T copy-mode-vi Enter
bind-key -T copy-mode-vi Enter send -X copy-pipe-and-cancel "reattach-to-user-namespace pbcopy"

# Split window shortcuts
bind-key t split-window -h -c ~/ "nvim todo.md"

# Notes: open or go to the "notes" window
bind-key m if-shell 'tmux list-windows | grep -q notes' 'select-window -t notes' 'new-window -n notes -c ~/github/notes "nvim +Neotree"'

# Open the rust playground project 
# bind-key P if-shell 'tmux list-windows | grep -q rust-playground' 'select-window -t rust-playground' 'new-window -n rust-playground -c ~/github/rust-playground "nvim src/main.rs"'
bind-key P split-window -h -c ~/ "cd ~/github/rust-playground && nvim 'src/main.rs'"

# rust repl
unbind-key r
bind-key r split-window -h -c ~/ "evcxr"


# open ~/.config/nvim with telescope in a split-window
bind-key V split-window -Z -h -c ~/ "cd ~/.config/nvim && nvim '+Telescope find_files'"

# open ~/.dotfiles/qmk with telescope
bind-key Q if-shell "tmux list-windows | grep -q qmk" "select-window -t qmk" "new-window -n qmk -c ~/.dotfiles/qmk nvim '+Telescope find_files'"

# do not ask for confirmation for kill window and pane shortcut
bind-key & kill-window
bind-key x kill-pane

# Easily swap a pane (targeted by pane number) with the current pane
# bind-key s display-panes\; command-prompt -p "pane #: "  "swap-pane -t '%%'"

# Prompted join-pane
bind-key J command-prompt -p "join pane from: "  "join-pane  -s '%%'"

# TODO maybe rebind <prefix>l to <prefix><space>

# tmux fzf plugin
TMUX_FZF_LAUNCH_KEY="f"


# initialize TMUX plugin manager (keep this line at the very bottom of tmux.conf)
run '~/.tmux/plugins/tpm/tpm'
